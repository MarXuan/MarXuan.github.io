<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <!-- Open Graph Data -->
  <meta property="og:title" content="jvm的对象创建"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="Hexo"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.com"/>
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Hexo</title>

  <!-- Bootstrap CSS -->
  
<link rel="stylesheet" href="/css/bootstrap.min.css">

  <!-- Custom CSS -->
  
  
<link rel="stylesheet" href="/css/style.light.css">


  <!-- Google Analytics -->
  

<meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">jvm的对象创建</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/<your-github-username>" target="_blank" rel="noopener">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:<your-email-address>">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By John Doe</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2018-07-15</span>
            <span class="time">10:26:04</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/jvm/">jvm</a>
</span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h1 id="jvm的对象创建"><a href="#jvm的对象创建" class="headerlink" title="jvm的对象创建"></a>jvm的对象创建</h1><h4 id="1-类加载检查"><a href="#1-类加载检查" class="headerlink" title="1.类加载检查"></a>1.类加载检查</h4><p>jvm在遇到new这个关键字时，先会去检查new的这个指令的参数是否能在常量池中定位到这个类的符号引用，因为常量池分为两部分：字面量和符号引用，字面量就是字符串值、常量值、基本类型数据的值等，而符号引用里面就包括了类和结构的完全限定名、字段名称和描述符以及方法的名称和描述符。如果能定位到，就检查这个类是否已经被加载过或者解析过，如果没加载，那就先加载这个类，加载这块就是双亲委派模型。</p>
<h4 id="2-分配内存"><a href="#2-分配内存" class="headerlink" title="2.分配内存"></a>2.分配内存</h4><p>new一个对象得分配内存，而对象所需的内存大小在类加载完后就已经确定。</p>
<p>内存的分配方式有两种：<strong>指针碰撞</strong>和<strong>空闲列表</strong>。两种方式的原理：</p>
<p>指针碰撞：用过的内存放到一边，没用过的放到另一边，然后有一个分界指针，向没用的内存方向移动到所需大小的位置即可。很明显，这种方式需要内存规整，所以是否选择这种方式取决于gc收集器的算法是不是“标记-整理”算法。</p>
<p>空闲列表：jvm会维护一个可用的内存列表，分配内存时就选取一个足够大的内存进行分配。这种方式就不需要内存有多么规整，所以是否选择这种方式就取决于gc收集器的算法是不是“标记-清楚”算法。</p>
<h5 id="内存分配并发问题"><a href="#内存分配并发问题" class="headerlink" title="内存分配并发问题"></a>内存分配并发问题</h5><p>还有一个内存分配的时候并发的问题：因为在实际中，创建对象是很频繁的，作为虚拟机来说，就必须要保证线程安全。jvm采用两种方式来保证：<strong>CAS+失败重试</strong>和<strong>TLAB</strong>。</p>
<p>​    CAS就是乐观锁，乐观锁就是不去显式加锁，假设每次没有冲突去执行某个操作，如果因为冲突失败就重试，jvm还在这个基础上采用了TLAB方式，TLAB是jvm会预先为每个线程在Eden区分配一块内存，在给线程中的对象分配内存时，首先在TLAB区分配，如果对象大于TLAB的剩余内存或TLAB用尽时，再采用CAS+失败重试的方式去分配。</p>
<h4 id="3-初始化零值"><a href="#3-初始化零值" class="headerlink" title="3.初始化零值"></a>3.初始化零值</h4><p>分配完内存后，jvm要对分配到的内存空间初始化，这就保证了对象的字段可以不用赋初值就能直接使用。</p>
<h4 id="4-设置对象头"><a href="#4-设置对象头" class="headerlink" title="4.设置对象头"></a>4.设置对象头</h4><p>初始化零值完成之后，虚拟机要对对象进行必要的设置，例如这个对象是那个类的实例、如何才能找到类的元数据信息、对象的哈希吗、对象的 GC 分代年龄等信息。 这些信息存放在对象头中。另外，根据虚拟机当前运行状态的不同，如是否启用偏向锁等，对象头会有不同的设置方式。</p>
<h4 id="5-执行-init-方法"><a href="#5-执行-init-方法" class="headerlink" title="5.执行 init 方法"></a>5.执行 init 方法</h4><p>上面四步完成后，从jvm的角度来说，一个对象已经创建完成了，但从程序角度来说，对象创建才刚开始，init方法还未执行，所有字段值都为零，说白了，就是根据所写程序来对字段赋值进行初始化。</p>
<p>额外的知识点：<strong>对象的内存布局</strong>   三部分：<strong>对象头</strong>、<strong>实例数据</strong>和<strong>对齐填充</strong></p>
<p>​    对象头包括两部分信息<strong>，</strong>第一部分用于存储对象自身的自身运行时数据（哈希码、GC分代年龄、锁状态标志等等），另一部分是类型指针，即对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是那个类的实例。</p>
<p>​    实例数据部分是对象真正存储的有效信息，也是在程序中所定义的各种类型的字段内容。</p>
<p>​    对齐填充部分不是必然存在的，也没有什么特别的含义，仅仅起占位作用。</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->

<script src="/js/highlight.pack.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

